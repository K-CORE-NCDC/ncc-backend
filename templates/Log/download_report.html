{% extends 'base.html' %}
{% block title %}Log list : Capture Log list{% endblock %}
{% load static %}
{% block content %}
  {% load i18n %}
  <div class="page-header page-header-light">
    <div class="breadcrumb-line breadcrumb-line-light header-elements-md-inline">
      <div class="breadcrumb">
        <a href="{% url 'home' %}" class="breadcrumb-item">
          <i class="icon-home2 mr-2"></i>
          <font style="vertical-align: inherit;">
            <font style="vertical-align: inherit;">
              {% translate 'Home' %}
            </font>
          </font>
        </a>
        <span class="breadcrumb-item">
          <font style="vertical-align: inherit;">
            <font style="vertical-align: inherit;">
              {% translate 'Program' %}
            </font>
          </font>
        </span>
        <span class="breadcrumb-item">
          <font style="vertical-align: inherit;">
            <font style="vertical-align: inherit;">
              {% translate 'Log' %}
            </font>
          </font>
        </span>
        <span class="breadcrumb-item active">
          <span class="font-weight-bold text-danger">
            <font style="vertical-align: inherit;">
              <font style="vertical-align: inherit;">
                {% translate 'Capture Log' %}
              </font>
            </font>
          </span>
        </span>
      </div>
    </div>

    <div class="content px-2 py-2 bg-white">
      <div class="card border-grey-300 my-0 mb-1">
        <div class="card-header bg-light header-elements-inline pl-2 py-2">
          <h6 class="card-title font-weight-bold font-size-sm">
            <font style="vertical-align: inherit;">
              <font style="vertical-align: inherit;">
                {% translate 'Capture Log list' %}
              </font>
            </font>
          </h6>
        </div>
        <div class="card-body px-2 py-2">
          <p class="pr-2 ml-3">
            {% translate 'Date Range' %}
          </p>

          <div class="d-flex flex-row ml-3">
            <div class="date-range-inputs d-flex mb-3">
              <div class="date-group mr-4">
                <label for="from_date" class="form-label">{% translate "From Date" %}</label>
                <input type="text" id="from_date" name="from_date" class="form-control" placeholder="from" aria-label="{% translate 'From Date' %}">
              </div>
              <div class="separator my-auto">
                <p class="mr-3">~</p>
              </div>
              <div class="date-group">
                <label for="to_date" class="form-label">{% translate "To Date" %}</label>
                <input type="text" id="to_date" name="to_date" class="form-control" placeholder="to" aria-label="{% translate 'To Date' %}">
              </div>
            </div>
            <button type="submit" id="dateRange" class="btn btn-primary ml-2" style="height:34px;">{% translate 'Submit' %}</button>
          </div>

          <div class="category-filter w-25 ml-3 mt-2 mb-4">
            <label for="categoryFilter" class="form-label">{% translate "Category Filter" %}</label>
            <select id="categoryFilter" name="categoryFilter" class="form-control" aria-label="{% translate 'Category Filter' %}">
              <option value="">{% translate "Show All" %}</option>
              <option value="Single">{% translate "Single Data Visualization" %}</option>
              <option value="Multi">{% translate "Multi Data Visualization" %}</option>
            </select>
          </div>

          <table class="table table-bordered table-hover table-xs" id="ourtable2">
            <caption></caption>
            <thead class="border">
              <tr>
                <th scope="col">
                  {% translate 'SNO' %}
                </th>
                <th scope="col">
                  {% translate 'User' %}
                </th>
                <th scope="col">
                  {% translate 'chart_name' %}
                </th>
                <th scope="col">
                  {% translate 'Date' %}
                </th>
                <th scope="col">
                  {% translate 'Category' %}
                </th>
              </tr>
            </thead>
            <tfoot></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  {% comment %} <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.2/css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/datetime/1.2.0/css/dataTables.dateTime.min.css" />

  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.3.2/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/datetime/1.2.0/js/dataTables.dateTime.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script> {% endcomment %}

  {% comment %} <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css" /> {% endcomment %}
 <link href="{% static 'admin_dashboard/css/dataTables.css' %}" rel="stylesheet" type="text/css" />

 {% comment %} <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.3.2/css/buttons.dataTables.min.css" /> {% endcomment %}
 <link href="{% static 'admin_dashboard/css/dataTablesmin.css' %}" rel="stylesheet" type="text/css" />

 <link href="{% static 'admin_dashboard/css/dataTablesdatetime.css' %}" rel="stylesheet" type="text/css" />

 {% comment %} <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script> {% endcomment %}
 <script src="{% static 'admin_dashboard/js/jqueryDataTables.js' %}"></script>
 {% comment %} <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.3.2/js/dataTables.buttons.min.js"></script> {% endcomment %}
 <script src="{% static 'admin_dashboard/js/jquerybuttons.js' %}"></script>

 {% comment %} <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script> {% endcomment %}
 <script src="{% static 'admin_dashboard/js/jszip.js' %}"></script>

 {% comment %} <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/buttons/2.3.2/js/buttons.html5.min.js"></script> {% endcomment %}
 <script src="{% static 'admin_dashboard/js/html5js.js' %}"></script>

 {% comment %} <script src="https://cdn.datatables.net/datetime/1.2.0/js/dataTables.dateTime.min.js"></script> {% endcomment %}
 <script src="{% static 'admin_dashboard/js/dataTablesdateTime.js' %}"></script>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
 <script src="{% static 'admin_dashboard/js/moment.js' %}"></script>


  <script>
    var fromDate, toDate

    // Custom filtering function which will search data in column four between two values
    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
      var from = fromDate.val()
      var to = toDate.val()
      var date = new Date(data[4])
      if ((from === null && to === null) || (from === null && date <= to) || (from <= date && to === null) || (from <= date && date <= to)) {
        return true
      }
      return false
    })

    $(document).ready(function () {
      function newexportaction(e, dt, button, config) {
        var self = this
        var oldStart = dt.settings()[0]._iDisplayStart
        dt.one('preXhr', function (e, s, data) {
          // Just this once, load all data from the server...
          data.start = 0
          data.length = 2147483647
          dt.one('preDraw', function (e, settings) {
            // Call the original action function
            if (button[0].className.indexOf('buttons-copy') >= 0) {
              $.fn.dataTable.ext.buttons.copyHtml5.action.call(self, e, dt, button, config)
            } else if (button[0].className.indexOf('buttons-excel') >= 0) {
              $.fn.dataTable.ext.buttons.excelHtml5.available(dt, config) ? $.fn.dataTable.ext.buttons.excelHtml5.action.call(self, e, dt, button, config) : $.fn.dataTable.ext.buttons.excelFlash.action.call(self, e, dt, button, config)
            } else if (button[0].className.indexOf('buttons-csv') >= 0) {
              $.fn.dataTable.ext.buttons.csvHtml5.available(dt, config) ? $.fn.dataTable.ext.buttons.csvHtml5.action.call(self, e, dt, button, config) : $.fn.dataTable.ext.buttons.csvFlash.action.call(self, e, dt, button, config)
            } else if (button[0].className.indexOf('buttons-pdf') >= 0) {
              $.fn.dataTable.ext.buttons.pdfHtml5.available(dt, config) ? $.fn.dataTable.ext.buttons.pdfHtml5.action.call(self, e, dt, button, config) : $.fn.dataTable.ext.buttons.pdfFlash.action.call(self, e, dt, button, config)
            } else if (button[0].className.indexOf('buttons-print') >= 0) {
              $.fn.dataTable.ext.buttons.print.action(e, dt, button, config)
            }
            dt.one('preXhr', function (e, s, data) {
              // DataTables thinks the first item displayed is index 0, but we're not drawing that.
              // Set the property to what it was before exporting.
              settings._iDisplayStart = oldStart
              data.start = oldStart
            })
            // Reload the grid with the original page. Otherwise, API functions like table.cell(this) don't work properly.
            setTimeout(dt.ajax.reload, 0)
            // Prevent rendering of the full data to the DOM
            return false
          })
        })
        // Requery the server with the new one-time export settings
        dt.ajax.reload()
      }

      fromDate = new DateTime($('#from_date'), {
        // format: 'MMMM Do YYYY'
        format: 'YYYY-MM-DD'
      })

      toDate = new DateTime($('#to_date'), {
        format: 'YYYY-MM-DD'
      })

      var table = $('#ourtable2').DataTable({
        processing: true,
        serverSide: true,
        pageLength: 10,

        ajax: {
          url: "{% url 'capture_log_data' %}",
          type: 'GET',
          data: function (d) {
            d.from = $('#from_date').val()
            d.to = $('#to_date').val()
            d.category = $('#categoryFilter').val();
          }
        },
        columns: [
          { data: '', defaultContent: '<b></b>' },
          { data: 'user__username', defaultContent: '<b></b>' },
          { data: 'chart_name', defaultContent: '<b></b>' },
          {
            data: 'created_on',
            defaultContent: '<b></b>',
            render: function (data, type, row) {
              return row?.created_on?.slice(0, 10)
            }
          },
          { data: 'category', defaultContent: '<b></b>' }
        ],
        dom: 'Blfrtip',
        columnDefs: [
          {
            visible: false,
            searchable: false
          }
        ],
        buttons: [
          {
            extend: 'excel',
            text: 'Excel',
            titleAttr: 'Excel',
            action: newexportaction
          },
          {
            extend: 'csv',
            text: 'CSV',
            titleAttr: 'CSV',
            action: newexportaction
          }
        ]
      })

      table.on('draw.dt', function () {
        var PageInfo = $('#ourtable2').DataTable().page.info()
        table
          .column(0, { page: 'current' })
          .nodes()
          .each(function (cell, i) {
            cell.innerHTML = '<p  class = "mr-3">' + (i + 1 + PageInfo.start) + '</p>'
          })
      })

      $('#dateRange').on('click', function () {
        table.draw()
      })

      var categoryFilter = $('#categoryFilter')

      // Add an event listener for changes in the dropdown selection
      categoryFilter.on('change', function () {
        // Get the selected value
        var selectedCategory = $(this).val()

        // Apply the filter to the DataTable
        table.column(4).search(selectedCategory).draw()
      })
    })
  </script>
{% endblock %}

{% comment %}{ text: 'Single Data', action: function (e, dt, node, config) { dt.column(4).data().search('Single Data').draw() } }, { text: 'Multi Data', action: function (e, dt, node, config) { dt.column(4).data().search('Multi Data').draw() } },{% endcomment %}
